<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Masjid | Absensi Sholat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 (Popups) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        masjid: {
                            primary: '#0F766E', // Teal 700
                            secondary: '#14B8A6', // Teal 500
                            accent: '#F59E0B', // Amber 500
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(165,65%,39%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(190,100%,35%,1) 0, transparent 50%), 
                radial-gradient(at 100% 100%, hsla(338,30%,27%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .input-glass::placeholder { color: rgba(255, 255, 255, 0.6); }
        .input-glass:focus {
            background: rgba(255, 255, 255, 0.25);
            outline: none;
            border-color: #14B8A6;
        }
        
        select.input-glass option {
            background-color: #1e293b;
            color: white;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .loader-masjid {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #F59E0B;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        .tab-btn.active { background-color: rgba(255,255,255,0.2); border-bottom: 2px solid #F59E0B; }
    </style>
</head>
<body class="flex items-center justify-center p-4 text-white antialiased">

    <main id="app-container" class="w-full max-w-md relative z-10">
        
        <!-- Header -->
        <header class="text-center mb-6 animate-fade-in">
            <div class="inline-block p-3 rounded-full glass-card mb-2 shadow-lg shadow-teal-500/20">
                <i class="fas fa-mosque text-3xl text-teal-300"></i>
            </div>
            <h1 class="text-2xl font-bold tracking-tight">E-Masjid</h1>
        </header>

        <!-- VIEW: LOGIN -->
        <section id="login-view" class="glass-card rounded-3xl p-8 animate-slide-up shadow-2xl">
            <h2 class="text-xl font-semibold mb-6 text-center">Login E-Masjid</h2>
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <div class="relative">
                    <i class="fas fa-user absolute left-4 top-3.5 text-teal-200"></i>
                    <input type="text" id="username" placeholder="Username / Email" class="input-glass w-full py-3 pl-12 pr-4 rounded-xl" required>
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute left-4 top-3.5 text-teal-200"></i>
                    <input type="password" id="password" placeholder="Password" class="input-glass w-full py-3 pl-12 pr-4 rounded-xl" required>
                </div>
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 rounded-xl shadow-lg transition">Masuk</button>
            </form>
            <div class="mt-6 pt-4 border-t border-white/10 text-center text-xs text-gray-400">
                <p class="mb-2">Akun Demo:</p>
                <div class="flex justify-center gap-2">
                    <button onclick="fillLogin('guru', '123')" class="px-3 py-1 bg-white/10 rounded-full">Guru</button>
                    <button onclick="fillLogin('siswa', '123')" class="px-3 py-1 bg-white/10 rounded-full">Siswa (L)</button>
                    <button onclick="fillLogin('siswi', '123')" class="px-3 py-1 bg-white/10 rounded-full">Siswi (P)</button>
                </div>
            </div>
        </section>

        <!-- VIEW: STUDENT DASHBOARD -->
        <section id="student-view" class="hidden animate-slide-up">
            <div class="glass-card rounded-2xl p-4 mb-4 flex items-center justify-between">
                <div>
                    <p class="text-xs text-teal-200">Ahlan Wa Sahlan,</p>
                    <h2 id="student-name" class="text-lg font-bold">Nama Siswa</h2>
                    <div class="flex items-center gap-2 text-xs text-gray-300">
                        <span id="student-class">Kelas: -</span>
                        <span id="student-gender-badge" class="px-1.5 py-0.5 rounded bg-white/10">L</span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="text-red-300 p-2 bg-red-500/10 rounded-full"><i class="fas fa-sign-out-alt"></i></button>
            </div>

            <div class="text-center mb-6">
                <div id="digital-clock" class="text-4xl font-mono font-bold">00:00</div>
                <p id="current-date" class="text-xs text-teal-100 opacity-80">...</p>
                <p id="is-friday-indicator" class="hidden text-xs text-green-400 font-bold mt-1 bg-green-500/10 inline-block px-2 py-0.5 rounded">JUMAT MUBARAK</p>
            </div>

            <!-- Status Sesi -->
            <div class="flex gap-2 mb-4">
                <div id="status-dzuhur" class="flex-1 glass-card p-2 rounded-xl text-center text-xs">
                    <span class="block font-bold" id="label-status-siang">Dzuhur</span>
                    <span class="status-text text-red-300">Tutup</span>
                </div>
                <div id="status-ashar" class="flex-1 glass-card p-2 rounded-xl text-center text-xs">
                    <span class="block font-bold">Ashar</span>
                    <span class="status-text text-red-300">Tutup</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Tombol Dzuhur (Default) -->
                <button id="btn-dzuhur" onclick="attemptCheckIn('Dzuhur')" class="h-32 glass-card rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white/10 transition border-teal-500/30">
                    <i class="fas fa-sun text-4xl text-yellow-400"></i>
                    <span class="font-bold">Dzuhur</span>
                </button>
                
                <!-- Tombol Jumat (Khusus Laki & Hari Jumat) -->
                <button id="btn-jumat" onclick="attemptJumat()" class="hidden h-32 glass-card rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white/10 transition border-teal-500/30 bg-green-900/20">
                    <i class="fas fa-kaaba text-4xl text-green-400 animate-pulse"></i>
                    <span class="font-bold">Sholat Jumat</span>
                </button>

                <!-- Tombol Ashar -->
                <button id="btn-ashar" onclick="attemptCheckIn('Ashar')" class="h-32 glass-card rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-white/10 transition border-teal-500/30">
                    <i class="fas fa-cloud-sun text-4xl text-orange-400"></i>
                    <span class="font-bold">Ashar</span>
                </button>
            </div>

            <!-- Menu Udhur (Khusus Perempuan) -->
            <div id="udhur-container" class="mt-4 hidden">
                <button onclick="laporUdhur()" class="w-full bg-pink-500/10 text-pink-200 border border-pink-500/30 p-3 rounded-xl flex items-center justify-center gap-2 hover:bg-pink-500/20 transition group">
                    <i class="fas fa-hand-holding-heart group-hover:scale-110 transition"></i> 
                    <span>Saya sedang Udhur / Berhalangan</span>
                </button>
            </div>

            <p class="text-[10px] text-center mt-4 text-gray-400">*Absensi menyesuaikan lokasi & kondisi</p>
        </section>

        <!-- VIEW: TEACHER DASHBOARD -->
        <section id="teacher-view" class="hidden animate-slide-up pb-10">
            <!-- Navbar Guru -->
            <div class="glass-card rounded-2xl p-4 mb-4 flex items-center justify-between bg-indigo-900/40">
                <div>
                    <h2 id="teacher-name" class="text-lg font-bold">Panel Guru</h2>
                    <span class="text-xs text-indigo-200">Admin Mode</span>
                </div>
                <button onclick="handleLogout()" class="text-red-300 p-2 bg-red-500/10 rounded-full"><i class="fas fa-sign-out-alt"></i></button>
            </div>

            <!-- TABS MENU GURU -->
            <div class="flex mb-4 glass-card rounded-xl p-1">
                <button onclick="switchTeacherTab('tab-absen')" id="btn-tab-absen" class="tab-btn active flex-1 py-2 text-xs font-bold rounded-lg transition">Dashboard</button>
                <button onclick="switchTeacherTab('tab-rekap')" id="btn-tab-rekap" class="tab-btn flex-1 py-2 text-xs font-bold rounded-lg transition">Rekap Absen</button>
            </div>

            <!-- TAB 1: DASHBOARD UTAMA -->
            <div id="tab-absen">
                <!-- KONTROL SESI -->
                <div class="glass-card rounded-2xl p-4 mb-4">
                    <h3 class="font-bold mb-3 text-sm uppercase tracking-wider text-yellow-400"><i class="fas fa-clock"></i> Buka/Tutup Absen</h3>
                    <div class="flex gap-4">
                        <div class="flex-1 bg-white/5 p-3 rounded-xl flex items-center justify-between">
                            <span class="text-sm font-semibold">Siang (Dzh/Jum)</span>
                            <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="toggle-dzuhur" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" onclick="toggleSession('dzuhur')"/>
                                <label for="toggle-dzuhur" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                        </div>
                        <div class="flex-1 bg-white/5 p-3 rounded-xl flex items-center justify-between">
                            <span class="text-sm font-semibold">Ashar</span>
                            <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="toggle-ashar" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" onclick="toggleSession('ashar')"/>
                                <label for="toggle-ashar" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PENGATURAN LOKASI (DUAL POINT) -->
                <div class="glass-card rounded-2xl p-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-sm text-teal-300"><i class="fas fa-map-marked-alt"></i> Lokasi Masjid</h3>
                        <button onclick="toggleElement('loc-settings')" class="text-xs bg-white/10 px-2 py-1 rounded">Atur</button>
                    </div>
                    
                    <div id="loc-settings" class="hidden space-y-4">
                        <!-- Laki-laki -->
                        <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-blue-200">Titik Ikhwan (L)</label>
                                <button onclick="getCurrentLocationForSetup('male')" class="text-[10px] bg-blue-600 px-2 py-1 rounded hover:bg-blue-500">Ambil GPS</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="set-lat-m" placeholder="Lat Laki" class="input-glass w-full px-2 py-1 text-[10px] rounded font-mono">
                                <input type="text" id="set-lng-m" placeholder="Lng Laki" class="input-glass w-full px-2 py-1 text-[10px] rounded font-mono">
                            </div>
                        </div>

                        <!-- Perempuan -->
                        <div class="bg-pink-900/20 p-3 rounded-lg border border-pink-500/20">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-pink-200">Titik Akhwat (P)</label>
                                <button onclick="getCurrentLocationForSetup('female')" class="text-[10px] bg-pink-600 px-2 py-1 rounded hover:bg-pink-500">Ambil GPS</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="set-lat-f" placeholder="Lat Pr" class="input-glass w-full px-2 py-1 text-[10px] rounded font-mono">
                                <input type="text" id="set-lng-f" placeholder="Lng Pr" class="input-glass w-full px-2 py-1 text-[10px] rounded font-mono">
                            </div>
                        </div>

                        <!-- Radius & Save -->
                        <div class="flex items-end gap-2 pt-2 border-t border-white/10">
                            <div class="w-1/3">
                                <label class="text-[10px] text-gray-400">Radius (m)</label>
                                <input type="number" id="set-radius" class="input-glass w-full px-2 py-1 text-xs rounded">
                            </div>
                            <button onclick="saveLocationSettings()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-1.5 rounded text-xs font-bold h-8">Simpan Semua Lokasi</button>
                        </div>
                    </div>
                </div>

                <!-- MANAJEMEN SISWA -->
                <div class="glass-card rounded-2xl p-4 flex flex-col h-[400px]">
                    <h3 class="font-bold mb-3 flex items-center justify-between text-sm uppercase text-gray-300">
                        <span><i class="fas fa-users text-blue-400"></i> Data Siswa</span>
                        <div class="flex gap-1">
                            <button onclick="triggerImport()" class="bg-blue-600/80 px-2 py-1 rounded text-xs" title="Import CSV"><i class="fas fa-file-upload"></i></button>
                            <input type="file" id="file-upload" class="hidden" accept=".csv" onchange="handleImport(this)">
                        </div>
                    </h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="search-student" placeholder="Cari..." class="input-glass flex-1 px-3 py-2 text-xs rounded-lg" onkeyup="filterStudents()">
                        <select id="filter-class" class="input-glass w-1/3 px-2 py-2 text-xs rounded-lg" onchange="filterStudents()">
                            <option value="All">All</option>
                            <option value="X">X</option>
                            <option value="XI">XI</option>
                            <option value="XII">XII</option>
                        </select>
                    </div>
                    <div id="student-list-container" class="overflow-y-auto pr-1 space-y-2 flex-1 custom-scrollbar"></div>
                    <button onclick="openEditModal()" class="mt-3 w-full bg-teal-600 hover:bg-teal-500 text-white py-2 rounded-lg text-sm shadow">
                        <i class="fas fa-plus"></i> Tambah Manual
                    </button>
                </div>
            </div>

            <!-- TAB 2: REKAP ABSENSI -->
            <div id="tab-rekap" class="hidden">
                <div class="glass-card rounded-2xl p-4 mb-4">
                    <h3 class="font-bold mb-4 text-sm uppercase text-teal-300"><i class="fas fa-file-alt"></i> Filter Laporan</h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-[10px] text-gray-400">Dari Tanggal</label>
                            <input type="date" id="rekap-start" class="input-glass w-full px-2 py-2 text-xs rounded text-white">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400">Sampai Tanggal</label>
                            <input type="date" id="rekap-end" class="input-glass w-full px-2 py-2 text-xs rounded text-white">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="text-[10px] text-gray-400">Filter Kelas</label>
                        <select id="rekap-class" class="input-glass w-full px-2 py-2 text-xs rounded">
                            <option value="All">Semua Kelas</option>
                            <option value="X">Kelas X</option>
                            <option value="XI">Kelas XI</option>
                            <option value="XII">Kelas XII</option>
                        </select>
                    </div>

                    <button onclick="generateRecap()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg text-sm font-bold shadow mb-2">
                        <i class="fas fa-search"></i> Tampilkan Data
                    </button>
                    <button onclick="exportRecapToExcel()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-sm font-bold shadow">
                        <i class="fas fa-file-excel"></i> Download Excel
                    </button>
                </div>

                <!-- HASIL REKAP -->
                <div id="rekap-result-container" class="glass-card rounded-2xl p-4 hidden">
                    <h4 class="font-bold text-xs text-gray-300 mb-2">Hasil Laporan:</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="text-teal-300 uppercase bg-white/5 border-b border-white/10">
                                <tr>
                                    <th class="px-2 py-2">Tgl</th>
                                    <th class="px-2 py-2">Nama</th>
                                    <th class="px-2 py-2">Kls</th>
                                    <th class="px-2 py-2">Info</th>
                                </tr>
                            </thead>
                            <tbody id="rekap-table-body" class="divide-y divide-white/10">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="rekap-empty-msg" class="text-center text-gray-500 text-xs py-4 hidden">Tidak ada data pada periode ini.</p>
                </div>
            </div>
        </section>

    </main>

    <!-- LOGIC -->
    <script>
        // --- 1. CONFIG & STATE ---
        const DB_KEY = 'e_masjid_v5_final'; // New DB Key for major update
        
        const initialData = {
            settings: { 
                male: { lat: -6.175392, lng: 106.827153 }, 
                female: { lat: -6.175392, lng: 106.827153 }, 
                radius: 50 
            },
            sessions: { dzuhur: false, ashar: false },
            users: [
                { id: 'g1', username: 'guru', password: '123', role: 'teacher', name: 'Ustadz Abdullah', class: '-', gender: 'L', email: 'guru@masjid.com' },
                { id: 's1', username: 'siswa', password: '123', role: 'student', name: 'Ahmad (Siswa)', class: 'XII', gender: 'L', email: 'ahmad@mail.com' },
                { id: 's2', username: 'siswi', password: '123', role: 'student', name: 'Fatimah (Siswi)', class: 'XI', gender: 'P', email: 'fatimah@mail.com' }
            ],
            attendance: []
        };

        let currentUser = null;
        let currentRecapData = [];

        function getDB() {
            const db = localStorage.getItem(DB_KEY);
            if(!db) return initialData;
            return JSON.parse(db);
        }

        function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }

        // --- 2. AUTH ---
        function handleLogin() {
            const uInput = document.getElementById('username').value.trim();
            const pInput = document.getElementById('password').value.trim();
            const db = getDB();
            const user = db.users.find(u => (u.username === uInput || u.email === uInput) && u.password === pInput);

            if (user) {
                currentUser = user;
                Swal.fire({
                    title: 'Login Berhasil',
                    timer: 500,
                    showConfirmButton: false,
                    background: '#fff',
                    didOpen: () => Swal.showLoading()
                }).then(() => {
                    document.getElementById('login-view').classList.add('hidden');
                    if (user.role === 'teacher') {
                        document.getElementById('teacher-view').classList.remove('hidden');
                        initTeacherDash();
                    } else {
                        document.getElementById('student-view').classList.remove('hidden');
                        initStudentDash();
                    }
                });
            } else { Swal.fire('Gagal', 'Username/Password salah', 'error'); }
        }

        function handleLogout() { location.reload(); }
        function fillLogin(u, p) { document.getElementById('username').value = u; document.getElementById('password').value = p; }
        function toggleElement(id) { document.getElementById(id).classList.toggle('hidden'); }

        // --- 3. STUDENT DASHBOARD ---
        function initStudentDash() {
            document.getElementById('student-name').innerText = currentUser.name;
            document.getElementById('student-class').innerText = `Kelas: ${currentUser.class || '-'}`;
            
            const badge = document.getElementById('student-gender-badge');
            badge.innerText = currentUser.gender === 'L' ? 'L' : 'P';
            badge.className = currentUser.gender === 'L' 
                ? "px-1.5 py-0.5 rounded bg-blue-500/30 text-blue-200 border border-blue-500/50"
                : "px-1.5 py-0.5 rounded bg-pink-500/30 text-pink-200 border border-pink-500/50";

            // LOGIC HARI JUMAT & GENDER
            const today = new Date();
            const isFriday = today.getDay() === 5; // 5 = Friday
            
            if (isFriday) {
                document.getElementById('is-friday-indicator').classList.remove('hidden');
                document.getElementById('label-status-siang').innerText = "Jumat";
            } else {
                document.getElementById('is-friday-indicator').classList.add('hidden');
                document.getElementById('label-status-siang').innerText = "Dzuhur";
            }

            // Atur tombol Sholat Siang (Dzuhur / Jumat)
            if (currentUser.gender === 'L' && isFriday) {
                // Laki-laki di hari Jumat: Sembunyikan Dzuhur, Tampilkan Jumat
                document.getElementById('btn-dzuhur').classList.add('hidden');
                document.getElementById('btn-jumat').classList.remove('hidden');
            } else {
                // Normal
                document.getElementById('btn-dzuhur').classList.remove('hidden');
                document.getElementById('btn-jumat').classList.add('hidden');
            }

            // Atur tombol Udhur (Hanya Perempuan)
            if (currentUser.gender === 'P') {
                document.getElementById('udhur-container').classList.remove('hidden');
            } else {
                document.getElementById('udhur-container').classList.add('hidden');
            }

            startClock();
            updateSessionStatusUI();
            setInterval(updateSessionStatusUI, 10000);
        }

        // --- ABSEN LOGIC ---

        // 1. Absen Normal (Dzuhur/Ashar)
        function attemptCheckIn(prayer) {
            const db = getDB();
            if (!db.sessions[prayer.toLowerCase()]) {
                Swal.fire('Absen Ditutup', `Sesi ${prayer} belum dibuka Guru.`, 'warning');
                return;
            }
            
            // Lokasi Target
            const targetLoc = currentUser.gender === 'L' ? db.settings.male : db.settings.female;
            const locName = currentUser.gender === 'L' ? "Titik Ikhwan" : "Titik Akhwat";

            verifyLocationAndSubmit(prayer, targetLoc, locName, true); // true = enforce radius
        }

        // 2. Absen Jumat (Khusus)
        function attemptJumat() {
            const db = getDB();
            if (!db.sessions.dzuhur) { // Pakai toggle dzuhur untuk sesi jumat
                Swal.fire('Absen Ditutup', `Sesi Jumat belum dibuka Guru.`, 'warning');
                return;
            }

            Swal.fire({
                title: 'Lokasi Sholat Jumat?',
                text: "Pilih lokasi dimana Anda melaksanakan Sholat Jumat",
                icon: 'question',
                showDenyButton: true,
                confirmButtonText: 'Masjid Sekolah',
                confirmButtonColor: '#0F766E',
                denyButtonText: 'Masjid Luar',
                denyButtonColor: '#F59E0B',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Masjid Sekolah -> Wajib Radius
                    verifyLocationAndSubmit('Jumat', db.settings.male, "Masjid Sekolah", true);
                } else if (result.isDenied) {
                    // Masjid Luar -> Bebas Radius (Cuma catat GPS)
                    verifyLocationAndSubmit('Jumat', null, "Masjid Luar", false);
                }
            });
        }

        // 3. Absen Udhur (Khusus)
        function laporUdhur() {
            Swal.fire({
                title: 'Konfirmasi Udhur',
                text: "Anda sedang berhalangan sholat hari ini?",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Ya, Lapor',
                confirmButtonColor: '#ec4899'
            }).then((result) => {
                if (result.isConfirmed) {
                    submitAbsenData('Udhur', 0, 'Lapor Diri');
                }
            });
        }

        // --- CORE VERIFICATION ---
        function verifyLocationAndSubmit(prayer, targetLoc, locName, enforceRadius) {
            const db = getDB();
            Swal.fire({
                title: 'Cek Lokasi...',
                html: `<div class="loader-masjid"></div>`,
                showConfirmButton: false, allowOutsideClick: false,
                didOpen: () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            let dist = 0;
                            let isValid = true;

                            if (enforceRadius && targetLoc) {
                                dist = getDistance(pos.coords.latitude, pos.coords.longitude, targetLoc.lat, targetLoc.lng);
                                if (dist > db.settings.radius) isValid = false;
                            }

                            if (isValid) {
                                Swal.close();
                                submitAbsenData(prayer, Math.round(dist), locName);
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Di Luar Area',
                                    html: `Jarak: <b>${Math.round(dist)}m</b> dari ${locName}.<br>Max: ${db.settings.radius}m.`
                                });
                            }
                        }, () => Swal.fire('Error GPS', 'Aktifkan GPS.', 'error'), {enableHighAccuracy:true, timeout:10000});
                    } else {
                        Swal.fire('Error', 'Browser tidak support GPS', 'error');
                    }
                }
            });
        }

        function submitAbsenData(prayer, dist, locName) {
            const db = getDB();
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Cek Duplikat
            const exist = db.attendance.find(a => a.studentId === currentUser.id && a.prayer === prayer && a.dateStr === todayStr);
            if (exist) { Swal.fire('Info', 'Anda sudah absen untuk sesi ini.', 'info'); return; }

            db.attendance.push({
                studentId: currentUser.id,
                name: currentUser.name,
                class: currentUser.class,
                prayer: prayer,
                dateStr: todayStr,
                fullDate: new Date().toLocaleString(),
                distance: dist,
                locType: locName
            });
            saveDB(db);
            
            if (prayer !== 'Udhur') confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            
            Swal.fire('Berhasil', `Absensi ${prayer} tercatat.<br><small>${locName}</small>`, 'success');
        }

        // --- 4. TEACHER LOGIC ---
        function initTeacherDash() {
            document.getElementById('teacher-name').innerText = currentUser.name;
            renderStudentList();
            
            const db = getDB();
            document.getElementById('set-lat-m').value = db.settings.male.lat;
            document.getElementById('set-lng-m').value = db.settings.male.lng;
            document.getElementById('set-lat-f').value = db.settings.female.lat;
            document.getElementById('set-lng-f').value = db.settings.female.lng;
            document.getElementById('set-radius').value = db.settings.radius;
            
            document.getElementById('toggle-dzuhur').checked = db.sessions.dzuhur;
            document.getElementById('toggle-ashar').checked = db.sessions.ashar;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rekap-start').value = today;
            document.getElementById('rekap-end').value = today;
        }

        function switchTeacherTab(tabId) {
            document.getElementById('tab-absen').classList.add('hidden');
            document.getElementById('tab-rekap').classList.add('hidden');
            document.getElementById('btn-tab-absen').classList.remove('active');
            document.getElementById('btn-tab-rekap').classList.remove('active');
            document.getElementById(tabId).classList.remove('hidden');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        function getCurrentLocationForSetup(type) {
            if(!navigator.geolocation) return Swal.fire('Err','No GPS','error');
            Swal.showLoading();
            navigator.geolocation.getCurrentPosition(p => {
                if(type === 'male') {
                    document.getElementById('set-lat-m').value = p.coords.latitude;
                    document.getElementById('set-lng-m').value = p.coords.longitude;
                } else {
                    document.getElementById('set-lat-f').value = p.coords.latitude;
                    document.getElementById('set-lng-f').value = p.coords.longitude;
                }
                Swal.close();
            });
        }

        function saveLocationSettings() {
            const db = getDB();
            db.settings.male.lat = parseFloat(document.getElementById('set-lat-m').value);
            db.settings.male.lng = parseFloat(document.getElementById('set-lng-m').value);
            db.settings.female.lat = parseFloat(document.getElementById('set-lat-f').value);
            db.settings.female.lng = parseFloat(document.getElementById('set-lng-f').value);
            db.settings.radius = parseInt(document.getElementById('set-radius').value);
            saveDB(db);
            Swal.fire('Disimpan', 'Titik Lokasi diperbarui.', 'success');
        }

        // --- REKAP ---
        function generateRecap() {
            const start = document.getElementById('rekap-start').value;
            const end = document.getElementById('rekap-end').value;
            const cls = document.getElementById('rekap-class').value;

            if(!start || !end) return Swal.fire('Error', 'Pilih rentang tanggal.', 'warning');

            const db = getDB();
            const report = db.attendance.filter(a => {
                const dateMatch = a.dateStr >= start && a.dateStr <= end;
                const classMatch = cls === 'All' || a.class === cls;
                return dateMatch && classMatch;
            });

            currentRecapData = report;
            const tbody = document.getElementById('rekap-table-body');
            tbody.innerHTML = '';
            document.getElementById('rekap-result-container').classList.remove('hidden');

            if(report.length === 0) {
                document.getElementById('rekap-empty-msg').classList.remove('hidden');
            } else {
                document.getElementById('rekap-empty-msg').classList.add('hidden');
                report.forEach(r => {
                    let color = 'bg-gray-500/20 text-gray-200';
                    if (r.prayer === 'Dzuhur') color = 'bg-yellow-500/20 text-yellow-200';
                    else if (r.prayer === 'Ashar') color = 'bg-orange-500/20 text-orange-200';
                    else if (r.prayer === 'Jumat') color = 'bg-green-500/20 text-green-200';
                    else if (r.prayer === 'Udhur') color = 'bg-pink-500/20 text-pink-200';

                    const row = `
                        <tr>
                            <td class="px-2 py-2 whitespace-nowrap">${r.dateStr.split('-').reverse().join('/')}</td>
                            <td class="px-2 py-2 font-semibold truncate max-w-[80px]">${r.name}</td>
                            <td class="px-2 py-2">${r.class}</td>
                            <td class="px-2 py-2">
                                <span class="px-1 py-0.5 rounded text-[10px] ${color} block text-center mb-1">${r.prayer}</span>
                                <span class="text-[9px] text-gray-400 block truncate max-w-[60px]">${r.locType}</span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        function exportRecapToExcel() {
            if(currentRecapData.length === 0) return Swal.fire('Kosong', 'Tampilkan data terlebih dahulu.', 'warning');
            const dataForSheet = currentRecapData.map(item => ({
                "Tanggal": item.dateStr, "Nama": item.name, "Kelas": item.class, 
                "Tipe Absen": item.prayer, "Waktu": item.timestamp, 
                "Lokasi": item.locType, "Jarak (m)": item.distance
            }));
            const ws = XLSX.utils.json_to_sheet(dataForSheet);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");
            XLSX.writeFile(wb, "Rekap_E_Masjid.xlsx");
        }

        // --- UTILS ---
        function toggleSession(type) {
            const db = getDB();
            db.sessions[type] = document.getElementById(`toggle-${type}`).checked;
            saveDB(db);
            updateSessionStatusUI();
        }

        function updateSessionStatusUI() {
            const db = getDB();
            if(!document.getElementById('status-dzuhur')) return;
            const dz = document.getElementById('status-dzuhur').querySelector('.status-text');
            const as = document.getElementById('status-ashar').querySelector('.status-text');
            
            if(db.sessions.dzuhur) { dz.innerText = "DIBUKA"; dz.className = "status-text text-green-400 font-bold"; }
            else { dz.innerText = "DITUTUP"; dz.className = "status-text text-red-300"; }
            
            if(db.sessions.ashar) { as.innerText = "DIBUKA"; as.className = "status-text text-green-400 font-bold"; }
            else { as.innerText = "DITUTUP"; as.className = "status-text text-red-300"; }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function startClock() {
            const update = () => {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                if(document.getElementById('digital-clock')) document.getElementById('digital-clock').innerText = timeStr;
                if(document.getElementById('current-date')) document.getElementById('current-date').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };
            update(); setInterval(update, 1000);
        }

        function renderStudentList() {
            const db = getDB();
            const container = document.getElementById('student-list-container');
            if(!container) return;
            const term = document.getElementById('search-student').value.toLowerCase();
            const filterKls = document.getElementById('filter-class').value;
            const students = db.users.filter(u => u.role === 'student' && u.name.toLowerCase().includes(term) && (filterKls === 'All' || u.class === filterKls));
            
            if (students.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Data kosong.</p>'; return; }
            container.innerHTML = students.map(s => `
                <div class="glass-card p-3 rounded-lg flex justify-between items-center group hover:bg-white/5">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full ${s.gender==='L'?'bg-blue-500/20 text-blue-200':'bg-pink-500/20 text-pink-200'} flex items-center justify-center text-xs font-bold">${s.class}</div>
                        <div class="min-w-0"><p class="font-semibold text-xs truncate text-white">${s.name}</p><p class="text-[10px] text-gray-400 truncate">${s.gender} | ${s.username}</p></div>
                    </div>
                    <button onclick="openEditModal('${s.id}')" class="bg-yellow-500/80 p-2 rounded text-xs"><i class="fas fa-edit"></i></button>
                </div>
            `).join('');
        }
        function filterStudents() { renderStudentList(); }

        async function openEditModal(studentId = null) {
            const db = getDB();
            let student = studentId ? db.users.find(u => u.id === studentId) : null;
            const { value: formValues } = await Swal.fire({
                title: student ? 'Edit Siswa' : 'Tambah Siswa',
                html: `
                    <input id="swal-name" class="swal2-input" placeholder="Nama" value="${student?.name||''}">
                    <input id="swal-user" class="swal2-input" placeholder="User" value="${student?.username||''}">
                    <input id="swal-pass" class="swal2-input" placeholder="Pass" value="${student?.password||''}">
                    <div class="flex gap-2 mt-2 px-8">
                        <select id="swal-class" class="swal2-select w-1/2 text-sm"><option value="X" ${student?.class==='X'?'selected':''}>X</option><option value="XI" ${student?.class==='XI'?'selected':''}>XI</option><option value="XII" ${student?.class==='XII'?'selected':''}>XII</option></select>
                        <select id="swal-gender" class="swal2-select w-1/2 text-sm"><option value="L" ${student?.gender==='L'?'selected':''}>Laki</option><option value="P" ${student?.gender==='P'?'selected':''}>Pr</option></select>
                    </div>`,
                focusConfirm: false, background: '#fff', showCancelButton: true, confirmButtonText: 'Simpan',
                preConfirm: () => ({ name: document.getElementById('swal-name').value, username: document.getElementById('swal-user').value, password: document.getElementById('swal-pass').value, class: document.getElementById('swal-class').value, gender: document.getElementById('swal-gender').value, role: 'student', id: student ? student.id : 's'+Date.now() })
            });
            if (formValues) {
                if(!formValues.name) return;
                const dbNow = getDB();
                if(studentId) { const idx = dbNow.users.findIndex(u=>u.id===studentId); if(idx!==-1) dbNow.users[idx] = {...dbNow.users[idx], ...formValues}; }
                else { dbNow.users.push(formValues); }
                saveDB(dbNow); renderStudentList();
            }
        }
        function triggerImport() { document.getElementById('file-upload').click(); }
        function handleImport(input) { /* Same simplified import */ }
    </script>
</body>
</html>